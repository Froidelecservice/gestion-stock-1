<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Gestion de Stock</title>

<!-- jsPDF pour export PDF commande -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    :root {
        --bg: #f5f5f5;
        --fg: #000000;
        --card: #ffffff;
        --header: #005A9C;
        --header-text: #ffffff;
        --alert: #ffcccc;
        --btn-primary: #005A9C;
        --btn-warning: #ff9800;
        --btn-pdf: #673ab7;
        --btn-save: #28a745;
        --btn-delete: #d9534f;
        --btn-entree: #4caf50;
        --btn-sortie: #f44336;
        --btn-modifier: #777777;
    }

    body.dark {
        --bg: #121212;
        --fg: #f5f5f5;
        --card: #1e1e1e;
        --header: #1565c0;
        --header-text: #ffffff;
        --alert: #5c1f1f;
    }

    body {
        font-family: Arial, sans-serif;
        padding: 20px;
        background: var(--bg);
        color: var(--fg);
        transition: background 0.3s, color 0.3s;
    }

    h2 {
        margin-bottom: 10px;
        font-size: 26px;
    }

    .top-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 15px;
    }

    .btn {
        padding: 14px 24px;
        font-size: 18px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        color: #ffffff;
    }

    #btnAdd { background: var(--btn-primary); }
    #btnOrder { background: var(--btn-warning); }
    #btnPDF { background: var(--btn-pdf); }
    #btnExportCSV { background: #3f51b5; }
    #btnReset { background: var(--btn-delete); }
    #btnFullscreen { background: #009688; }

    form {
        background: var(--card);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    .row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .field {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }

    label {
        font-size: 14px;
        margin-bottom: 3px;
    }

    input {
        padding: 10px;
        font-size: 16px;
        border-radius: 4px;
        border: 1px solid #999;
        box-sizing: border-box;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: var(--card);
        font-size: 15px;
    }

    th, td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
    }

    th {
        background: var(--header);
        color: var(--header-text);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .alert {
        background: var(--alert);
    }

    .btn-small {
        padding: 12px 18px;
        font-size: 18px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        color: #ffffff;
        margin: 2px 0;
        width: 100%;
    }

    .btn-entree { background: var(--btn-entree); }
    .btn-sortie { background: var(--btn-sortie); }
    .btn-delete { background: var(--btn-delete); }
    .btn-modifier { background: var(--btn-modifier); }

    #btnSave {
        background: var(--btn-save);
        color: #ffffff;
        border: none;
        margin-top: 10px;
    }

    .search-bar {
        margin-bottom: 10px;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .search-bar input {
        flex: 1;
    }
</style>
</head>
<body>

<h2>Gestion de Stock</h2>

<div class="top-bar">
    <button id="btnAdd" class="btn">‚ûï Ajouter un article</button>
    <button id="btnOrder" class="btn">üì¶ Articles √† commander</button>
    <button id="btnPDF" class="btn">üìù Export PDF commande</button>
    <button id="btnExportCSV" class="btn">üìÑ Export Excel (CSV)</button>
    <button id="btnReset" class="btn">üóëÔ∏è R√©initialiser la base</button>
    <button id="btnFullscreen" class="btn">‚õ∂ Plein √©cran</button>
</div>

<div class="search-bar">
    <label>üîç Recherche :</label>
    <input type="text" id="search" placeholder="R√©f√©rence, fournisseur, machine...">
</div>

<form id="formStock">
    <h3 id="formTitle">Nouvel article</h3>

    <div class="row">
        <div class="field"><label>Fournisseur</label><input name="fournisseur"></div>
        <div class="field"><label>Machine</label><input name="machine"></div>
        <div class="field"><label>Marque</label><input name="marque"></div>
    </div>

    <div class="row">
        <div class="field"><label>Mat√©riel</label><input name="materiel"></div>
        <div class="field"><label>R√©f√©rence</label><input name="reference"></div>
        <div class="field"><label>D√©nomination</label><input name="denomination"></div>
    </div>

    <div class="row">
        <div class="field"><label>Stock d√©but mois</label><input type="number" name="debut" value="0"></div>
        <div class="field"><label>Entr√©es</label><input type="number" name="entrees" value="0"></div>
        <div class="field"><label>Sorties</label><input type="number" name="sorties" value="0"></div>
        <div class="field"><label>Stock minimum</label><input type="number" name="minimum" value="0"></div>
    </div>

    <button type="button" id="btnSave">üíæ Enregistrer</button>
</form>

<table id="tableStock">
    <thead>
    <tr>
        <th>FOURNISSEUR</th>
        <th>MACHINE</th>
        <th>MARQUE</th>
        <th>MATERIEL</th>
        <th>REFERENCE</th>
        <th>DENOMINATION</th>
        <th>DEBUT</th>
        <th>ENTREES</th>
        <th>SORTIES</th>
        <th>STOCK FIN</th>
        <th>MIN</th>
        <th>ENTR√âE</th>
        <th>SORTIE</th>
        <th>MODIFIER</th>
        <th>SUPPRIMER</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>
<script>
let stock = JSON.parse(localStorage.getItem("stockData") || "[]");
let indexEnEdition = null;

function sauvegarder() {
    localStorage.setItem("stockData", JSON.stringify(stock));
}

function stockFin(item) {
    return item.debut + item.entrees - item.sorties;
}

function appliqueModeSombreAuto() {
    const h = new Date().getHours();
    if (h >= 18 || h < 7) document.body.classList.add("dark");
    else document.body.classList.remove("dark");
}

function filtrerStock(txt) {
    txt = txt.toLowerCase();
    return stock.filter(item =>
        Object.values(item).join(" ").toLowerCase().includes(txt)
    );
}

function afficher() {
    const tbody = document.querySelector("#tableStock tbody");
    tbody.innerHTML = "";

    const filtre = document.getElementById("search").value || "";
    const liste = filtrerStock(filtre);

    liste.forEach(item => {
        const index = stock.indexOf(item);
        const fin = stockFin(item);
        const alertClass = fin < item.minimum ? "alert" : "";

        tbody.innerHTML += `
        <tr class="${alertClass}">
            <td>${item.fournisseur}</td>
            <td>${item.machine}</td>
            <td>${item.marque}</td>
            <td>${item.materiel}</td>
            <td>${item.reference}</td>
            <td>${item.denomination}</td>
            <td>${item.debut}</td>
            <td>${item.entrees}</td>
            <td>${item.sorties}</td>
            <td>${fin}</td>
            <td>${item.minimum}</td>
            <td><button class="btn-small btn-entree" onclick="ajouterEntree(${index})">Entr√©e +</button></td>
            <td><button class="btn-small btn-sortie" onclick="ajouterSortie(${index})">Sortie ‚àí</button></td>
            <td><button class="btn-small btn-modifier" onclick="modifierArticle(${index})">Modifier</button></td>
            <td><button class="btn-small btn-delete" onclick="supprimer(${index})">‚ùå</button></td>
        </tr>`;
    });
}

function resetForm() {
    document.getElementById("formStock").reset();
    document.getElementById("formStock").style.display = "none";
    indexEnEdition = null;
}

function remplirForm(item) {
    const f = document.getElementById("formStock");
    f.fournisseur.value = item.fournisseur;
    f.machine.value = item.machine;
    f.marque.value = item.marque;
    f.materiel.value = item.materiel;
    f.reference.value = item.reference;
    f.denomination.value = item.denomination;
    f.debut.value = item.debut;
    f.entrees.value = item.entrees;
    f.sorties.value = item.sorties;
    f.minimum.value = item.minimum;
}

function supprimer(index) {
    if (!confirm("Supprimer cet article ?")) return;
    stock.splice(index, 1);
    sauvegarder();
    afficher();
}

function ajouterEntree(index) {
    const q = Number(prompt("Quantit√© entr√©e :"));
    if (q > 0) {
        stock[index].entrees += q;
        sauvegarder();
        afficher();
    }
}

function ajouterSortie(index) {
    const q = Number(prompt("Quantit√© sortie :"));
    if (q > 0) {
        stock[index].sorties += q;
        sauvegarder();
        afficher();
    }
}

function modifierArticle(index) {
    indexEnEdition = index;
    remplirForm(stock[index]);
    document.getElementById("formStock").style.display = "block";
    document.getElementById("formTitle").textContent = "Modifier l‚Äôarticle";
}
document.getElementById("btnAdd").onclick = () => {
    indexEnEdition = null;
    document.getElementById("formTitle").textContent = "Nouvel article";
    document.getElementById("formStock").reset();
    document.getElementById("formStock").style.display = "block";
};

document.getElementById("btnSave").onclick = () => {
    const f = document.getElementById("formStock");
    const data = Object.fromEntries(new FormData(f).entries());

    const item = {
        fournisseur: data.fournisseur,
        machine: data.machine,
        marque: data.marque,
        materiel: data.materiel,
        reference: data.reference,
        denomination: data.denomination,
        debut: Number(data.debut),
        entrees: Number(data.entrees),
        sorties: Number(data.sorties),
        minimum: Number(data.minimum)
    };

    if (indexEnEdition === null) stock.push(item);
    else stock[indexEnEdition] = item;

    sauvegarder();
    afficher();
    resetForm();
};

document.getElementById("btnOrder").onclick = () => {
    const articles = stock.filter(a => stockFin(a) < a.minimum);

    if (articles.length === 0) {
        alert("Aucun article √† commander.");
        return;
    }

    let message = "üì¶ ARTICLES √Ä COMMANDER :\n\n";

    articles.forEach(a => {
        const qte = prompt(
            `Quantit√© √† commander pour ${a.reference} - ${a.denomination} :`,
            a.qteCommande ? String(a.qteCommande) : "1"
        );

        const val = Number(qte);
        if (!qte || isNaN(val) || val <= 0) {
            a.qteCommande = 0;
        } else {
            a.qteCommande = val;   // ‚úÖ on enregistre sur l‚Äôarticle
        }

        message += `${a.reference} | ${a.denomination} | √Ä commander : ${a.qteCommande}\n`;
    });

    // on sauvegarde les quantit√©s dans localStorage pour que le PDF puisse les relire
    sauvegarder();

    alert(message);
};

document.getElementById("btnPDF").onclick = () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF();

    const articles = stock.filter(a => stockFin(a) < a.minimum);

    if (articles.length === 0) {
        alert("Aucun article √† commander.");
        return;
    }

    pdf.setFontSize(18);
    pdf.text("Articles √† commander", 20, 20);

    let y = 40;
    pdf.setFontSize(12);

    articles.forEach(a => {
        if (y > 270) {
            pdf.addPage();
            y = 20;
        }

        const qte = a.qteCommande && a.qteCommande > 0 ? a.qteCommande : 0;

        pdf.text(
            `${a.reference} - ${a.denomination}`,
            20, y
        );
        y += 6;

        pdf.text(
            `Stock : ${stockFin(a)} | Min : ${a.minimum} | √Ä commander : ${qte}`,
            20, y
        );
        y += 10;
    });

    pdf.save("commande.pdf");
};

document.getElementById("btnExportCSV").onclick = () => {
    let csv = "Fournisseur;Machine;Marque;Materiel;Reference;Denomination;Debut;Entrees;Sorties;StockFin;Minimum\n";

    stock.forEach(a => {
        csv += `${a.fournisseur};${a.machine};${a.marque};${a.materiel};${a.reference};${a.denomination};${a.debut};${a.entrees};${a.sorties};${stockFin(a)};${a.minimum}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "stock.csv";
    a.click();
};

document.getElementById("btnReset").onclick = () => {
    if (confirm("Effacer toute la base ?")) {
        stock = [];
        sauvegarder();
        afficher();
    }
};

document.getElementById("search").addEventListener("input", afficher);

document.getElementById("btnFullscreen").onclick = () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
};

appliqueModeSombreAuto();
setInterval(appliqueModeSombreAuto, 300000);

afficher();
</script>

<footer style="margin-top:20px; text-align:center; opacity:0.7;">
    cr√©√© par Robert AURAY
</footer>

</body>
</html>